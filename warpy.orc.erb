/*
 * This file is part of Warpy.
 *
 * Warpy is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Warpy is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Warpy.  If not, see <https://www.gnu.org/licenses/>.
 */

massign 0,1

gistereo init 0
gisampleready init 0
gkfirstrun init 1
gSpath init ""
gisampledur init 0
gkreleaseline init 0

instr PathGetter
    gSpath chnget "path"

    knewfile changed2 gSpath
    ipathempty strcmp gSpath, ""
    if ((knewfile == 1) || ((gkfirstrun == 1) && (ipathempty != 0))) then
        event "i", "FileLoader", 0, 0
        if gkfirstrun == 1 then
            gkfirstrun = 0
        endif
    endif
endin

instr +FileLoader
    ichannels filenchnls gSpath
    gistereo = ichannels - 1
    gileftchan ftgen 1, 0, 0, 1, gSpath, 0, 0, 1
    if gistereo == 1 then
        girightchan ftgen 2, 0, 0, 1, gSpath, 0, 0, 2
    endif
    gisampledur chnget "sample_dur"
    gisampleready = 1
endin

instr 1
    if gisampleready == 1 then
        kgain     chnget "gain"
        <%= VocoderParams.new('speed', 'k').params %>
        <%= VocoderParams.new('pitch', 'k').params %>
        ; envelope
        ienvatt   chnget "env_attack_time"
        ienvattsh chnget "env_attack_shape"
        ienvdec   chnget "env_decay_time"
        ienvdecsh chnget "env_decay_shape"
        ienvsus   chnget "env_sustain_level"
        ienvrel   chnget "env_release_time"
        ienvrelsh chnget "env_release_shape"
        ; reverse
        kreverse chnget "reverse"
        ; loop times
        imainlooptimes chnget "loop_times"
        ; start and end points
        istart chnget "start_point"
        iend   chnget "end_point"
        ; sustain
        ksustainsection chnget "sustain_section"
        ksustainstart chnget "sustain_start_point"
        ksustainend   chnget "sustain_end_point"
        isusmainlooplimit = imainlooptimes + 1
        ; release
        ireleasesection   chnget "release_section"
        ireleasestart     chnget "release_start_point"
        ireleaseend       chnget "release_end_point"
        ireleaselooptimes chnget "release_loop_times"

        kmainloops init 0
        imainbaserate = <%= base_rate('istart', 'iend') %>

        iamp  ampmidi 1
        imfreq cpsmidi

        kreleased init 0
        ireleasebaserate = <%= base_rate('ireleasestart', 'ireleaseend') %>
        kreleaseloops init 0

        if <%= phase_over('main') %> && \
           !<%= sustain_on %> && \
           <%= release_on %> then
            kreleased = 1
        else
            kreleased release
        endif

        <%= VocoderParams.new('speed', 'k').param_process %>
        <%= VocoderParams.new('pitch', 'k').param_process %>

        aenv transegr 0,       ienvatt, ienvattsh, \
                      1,       ienvdec, ienvdecsh, \
                      ienvsus, ienvrel, ienvrelsh, \
                      0

        if kreleased == 1 then
            if <%= release_on %> then
                kmainloops = kmainloops
                kreleaseloops += <%= kline('ireleasebaserate') %>
            else
                kstop = 1
            endif
        elseif <%= in_sustain_phase %> then
            kmainloops = kmainloops
        else
            kmainloops += <%= kline('imainbaserate') %>
        endif

        krate = (kspeedfinal / gisampledur)
        if kreleased == 1 then
            <%= scaled_pointer(phase: 'release') %>
        elseif <%= in_sustain_phase %> then
            <%= scaled_pointer(phase: 'sustain', vartype: 'k') %>
        elseif (istart > 0 || iend < 1) then
            <%= scaled_pointer %>
        else
            apointer phasor krate
        endif

        if kreverse == 1 then
            asamplepos = abs(apointer - 0.9)*gisampledur
        else
            asamplepos = apointer*gisampledur
        endif

        if gistereo == 1 then
            apresigl <%= mincer_out('gileftchan') %>
            apresigr <%= mincer_out('girightchan') %>
        else
            apresigl <%= mincer_out('gileftchan') %>
            apresigr = apresigl
        endif

        asigl = apresigl * aenv
        asigr = apresigr * aenv

        kdialdown init 1
        kstop init 0

        if (<%= phase_over('main', early: 0.1) %> && \
            !<%= release_on %> && !<%= sustain_on %>) || \
           <%= phase_over('release', early: 0.1) %> then
            kstop = 1
        endif

        if kstop == 1 then
            kdialdown = kdialdown - 0.3
            if kdialdown < 0 then
                kdialdown = 0
            endif
            asigl = asigl * kdialdown
            asigr = asigr * kdialdown
        endif

        outs asigl, asigr
    endif
endin

